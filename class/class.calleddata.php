<?php	require_once("../sisipan/sessions.php");	require_once("../fungsi/global.php");	require_once("../class/MYSQLConnect.php");	require_once("../class/lib.form.php");		class MoveData extends mysql{			function __construct(){			parent::__construct();		}						function index(){			if( $this -> havepost('action'))			{				switch($_REQUEST['action'])				{					case 'get_agent_byspv'	 : $this -> getAgentBySpv(); 	break;					case 'get_data_null'  	 : $this -> getData(); 			break;					case 'get_fromspv_byam'	 : $this -> getSpvFromAM();		break;						case 'get_tospv_byam'	 : $this -> getSpvToAM(); 		break;					case 'get_toagent_byspv' : $this -> getToAgentBySpv(); 	break;					case 'move_to_spv'    	 : $this -> MoveToSPV(); 		break;					case 'move_to_agent'	 : $this -> MoveToAgent(); 		break;					case 'move_to_mgr'	 	 : $this -> MoveToMgr(); 		break;										}			}		}			/** get list form am ***/		function getSpvFromAM()		{			$sql = "select a.UserId, a.id, a.full_name 					from tms_agent a 					left join tms_agent_profile b on a.profile_id=b.id 					where b.id=3					and a.mgr_id='".$_REQUEST['ManagerId']."'" ;			$qry = $this -> query($sql);			foreach($qry -> result_array() as $rows )			{				$datas[$rows[0]] = $rows[1].' - '.$rows[2]; 			}						$this -> setForm() -> jpCombo('FromSupervisorId','select',$datas,NULL,'onChange="AgentBySpv(this);"');				}			/** get list form am ***/		function getSpvToAM()		{			$sql = "select a.UserId, a.id, a.full_name 					from tms_agent a 					left join tms_agent_profile b on a.profile_id=b.id 					where b.id=3					and a.mgr_id='".$_REQUEST['ManagerId']."'" ;			$qry = $this -> query($sql);			foreach($qry -> result_array() as $rows )			{				$datas[$rows[0]] = $rows[1].' - '.$rows[2]; 			}						$this -> setForm() -> jpCombo('ToSupervisorId','select',$datas,NULL,'onChange="ToAgentBySpv(this);"');				}				/** ************************/			function MoveToSPV()		{			$Qty = 0;			if( $this -> havepost('CustomerId') && $this -> havepost('ToSupervisorId')){				$QtyCustomers = explode(',',$_REQUEST['CustomerId']);				foreach($QtyCustomers as $k=>$v ){					$sql = " UPDATE t_gn_assignment a 							SET a.AssignSpv ='".$_REQUEST['ToSupervisorId']."', 								a.AssignSelerId = NULL   							WHERE a.CustomerId = '".$v."'";					$result = $this -> execute($sql,__FILE__,__LINE__);					if( $result ) $Qty+=1;				}			}						echo json_encode(array('total'=>$Qty, 'spv'=>'Move New Data'));		}			/** move to manager ****/			function MoveToMgr()		{			$Qty = 0;			if( $this -> havepost('CustomerId') && $this -> havepost('ToManagerId')){				$QtyCustomers = explode(',',$_REQUEST['CustomerId']);				foreach($QtyCustomers as $k=>$v ){					$sql = " UPDATE t_gn_assignment a 							SET a.AssignMgr ='".$_REQUEST['ToManagerId']."', 								a.AssignSpv = NULL,								a.AssignSelerId = NULL   							WHERE a.CustomerId = '".$v."'";					$result = $this -> execute($sql,__FILE__,__LINE__);					if( $result ) $Qty+=1;				}			}						echo json_encode(array('total'=>$Qty, 'spv'=>'Move New Data'));				}		/** &&&&&&&&&&&&&&&&&&& ***********/			function MoveToAgent()		{			$QtyCustomers = explode(',',$_REQUEST['CustomerId']);			$QtyAgents 	  = explode(',',$_REQUEST['ToSellerId']);			$QtnCustomers = (int)$_REQUEST['SizeData']; // count($QtyCustomers);			$QtnAgents 	  = count($QtyAgents);			$QtnPerAgents = 0;			$dataSize 	  = array();						if( $QtnCustomers> 0 && $QtnAgents >0 )			{				$QtnPerAgents = floor($QtnCustomers/$QtnAgents);				$TotPerAgents = ($QtnCustomers-($QtnPerAgents*$QtnAgents));				$start = 0;				foreach($QtyAgents as $a => $b)				{					if( $start==($QtnAgents-1)){						$no = ($start* $QtnPerAgents);						$dataSize[$b]= $this -> AssignSize(($QtnPerAgents+$TotPerAgents),$no, $b);					}					else					{						$no = ($start* $QtnPerAgents);						$dataSize[$b]= $this -> AssignSize($QtnPerAgents,$no, $b);					}											$start++;				}							}			if( is_array($dataSize))			{				foreach($dataSize as $agentId => $value)				{					foreach($value as $i=> $customerId)					{						$sql = " UPDATE t_gn_assignment a 								 SET a.AssignSpv ='".$_REQUEST['ToSupervisorId']."',  									 a.AssignSelerId ='".$agentId."',								    a.AssignBlock=0,									a.AssignMode='MOV'								 WHERE a.CustomerId = '".$customerId."'";						$this -> execute($sql,__FILE__,__LINE__);	 					}				}			}						echo json_encode(array('total'=>$QtnCustomers,'spv'=>'Move New Data', 'agent'=>$QtnAgents ,'peragent'=>$QtnPerAgents ));					}		/** get assig Size ****/		function AssignSize($QtyAllow=0, $start = 0,$v=0)		{			$QtyCustomers = explode(',',$_REQUEST['CustomerId']);			return array_slice				(					$QtyCustomers,					$start,					$QtyAllow				);		}				private function setForm()		{			return new jpForm(true);		}						public function getData(){			$QtySize = '<table width="100%" class="custom-grid" cellspacing="0">						<thead>							<tr height="20"> 								<th nowrap class="custom-grid th-first">&nbsp;<a href="javascript:void(0);" onclick="CheckListData();">#</a></th>									<th nowrap class="custom-grid th-middle">&nbsp;No.</th>								<th nowrap class="custom-grid th-middle">&nbsp;Customer Number.</th>								<th nowrap class="custom-grid th-middle">&nbsp;Customer Name.</th>								<th nowrap class="custom-grid th-middle">&nbsp;Campaign Name.</th>								<th nowrap class="custom-grid th-middle">&nbsp;Call Reason.</th>								<th nowrap class="custom-grid th-middle">&nbsp;Assign User.</th>								<th nowrap class="custom-grid th-lasted">&nbsp;Assign Date.</th>							</tr>						</thead>';									$sql = "					select * from t_gn_assignment a 						left join t_gn_customer b on a.CustomerId=b.CustomerId						left join t_gn_campaign c on b.CampaignId=c.CampaignId 						left join tms_agent d on a.AssignSelerId=d.UserId						left join t_lk_callreason f on b.CallReasonId=f.CallReasonId					where b.CallReasonId IN(".$_REQUEST['CallReasonId'].") AND b.CampaignId IN(".$_REQUEST['CampaignId'].") ";							if( $this ->havepost('ManagerId')) :	$sql .=" and a.AssignMgr IN (".$_REQUEST['ManagerId'].") "; endif;					if( $this ->havepost('SupervisorId')) :	$sql .=" and a.AssignSpv IN (".$_REQUEST['SupervisorId'].") "; endif;			if( $this ->havepost('SellerId')) :	$sql .=" and a.AssignSelerId IN (".$_REQUEST['SellerId'].") "; endif;			//echo $sql;				$qry = $this -> execute($sql,__FILE__,__LINE__);						$dataSize  =0;			$no = 1;			while( $rows = $this ->fetchassoc($qry)){								$QtySize.= '<tr class="onselect">'.							'<td class="content-first"><input type="checkbox" value="'.$rows['CustomerId'].'" name="chk_cust_dist" name="chk_cust_dist" onclick="RandomClick();"></td>'.							'<td class="content-middle">'.$no.'</td>'.							'<td class="content-middle">'.$rows['CustomerNumber'].'</td>'.							'<td class="content-middle">'.$rows['CustomerFirstName'].'</td>'.							'<td class="content-middle"><b style="color:green;">'.$rows['CampaignName'].'<b></td>'.							'<td class="content-middle"><b style="color:green;">'.$rows['CallReasonDesc'].'<b></td>'.							'<td class="content-middle"><b style="color:green;">'.$rows['full_name'].'<b></td>'.							'<td class="content-lasted">'.$db->Date->date_time_indonesia($rows['AssignDate']).'</td>'.						'</tr>';				$dataSize+=1; $no++;											}						$QtySize.='</table>';						echo json_encode(array('table'=>$QtySize, 'total'=>$dataSize));								}				public function getAgentBySpv()		{			$sql = " 					select a.UserId, a.id, a.full_name 						from tms_agent a 						left join tms_agent_profile b on a.profile_id=b.id 					where b.id=4					and a.spv_id='".$_REQUEST['SupervisorId']."'" ;			$qry = $this -> execute($sql,__FILE__,__LINE__);			while( $rows = $this ->fetcharray($qry)){				$datas[$rows[0]] = $rows[1].' - '.$rows[2]; 			}						$this -> setForm() -> jpMultiple('SellerId','select_multiple',$datas);		}				public function getToAgentBySpv()		{			$sql = " 					select a.UserId, a.id, a.full_name 						from tms_agent a 						left join tms_agent_profile b on a.profile_id=b.id 					where b.id=4					and a.spv_id='".$_REQUEST['SupervisorId']."'" ;			$qry = $this -> execute($sql,__FILE__,__LINE__);			while( $rows = $this ->fetcharray($qry)){				$datas[$rows[0]] = $rows[1].' - '.$rows[2]; 			}						$this -> setForm() -> jpMultiple('ToxSellerId','select_multiple',$datas);		}	}				$MoveData = new MoveData(true);	$MoveData -> index(); ?>