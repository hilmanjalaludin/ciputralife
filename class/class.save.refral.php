<?phprequire(dirname(__FILE__)."/../sisipan/sessions.php");require(dirname(__FILE__)."/../fungsi/global.php");require(dirname(__FILE__)."/../class/MYSQLConnect.php");class saveReferal extends mysql{  var $CustomerId; var $Action;		function saveReferal()	{		parent::__construct();		$this -> Action	= $this -> escPost('action');		$this -> CustomerId = $this -> escPost('CustomerId');		// print_r($this->getCountReferal());		// exit;		self::index();	}	function _getListBox()	{		$_ChkBox = null;		if( $this -> havepost('ChkBox'))		{			$_aChkBox = explode(",",$this -> escPost('ChkBox'));			if( is_array($_aChkBox)){				$_ChkBox = $_aChkBox;			}		}		return $_ChkBox;	}				function getReferalId(){		$sql = " select * from t_gn_referal a where a.ReferalCustomerId='".$this ->CustomerId."' and a.ReferalQAStatus is null";		$qry = $this -> query($sql);		$i=0;				foreach($qry -> result_assoc() as $rows )		{			$data[$i]=$rows['ReferalId']; 						$i++;		}		//print_r($data);		return $data;	 }		function getCountReferal()	{		$sql = "select count(*) as jumlah from t_gn_referal a where a.ReferalQAStatus = 1 and a.ReferalCustomerId = '".$this ->CustomerId."'				group by date(a.ReferalApprovalTs)";		$qry = $this -> query($sql);						foreach ( $qry->result_assoc() as $rows){			$data = $rows['jumlah'];		}				return $data;	}		function freePA()	{		$SQL_UPDATE = array();		$WHERE		= array();				$SQL_UPDATE['CustomerFreePA'] = 1;		$WHERE['CustomerId'] = $this -> CustomerId;				return $this -> set_mysql_update("t_gn_customer",$this -> SQLnull($SQL_UPDATE),$WHERE);	}		function index()	{		switch($this -> Action)		{				case 'save' : $this -> Save(); break;			case 'update' : $this -> Update(); break;			case 'approve' : $this -> Approve(); break;			case 'reject' : $this -> Reject(); break;		}	}		function Reject()	{		$result  = array("result"=>0,'data'=>$_REQUEST);		$RefId	 = $this->getReferalId();		$ListBox = self::_getListBox();		if(is_array( $ListBox ) ){			$_tot = 0;			foreach( $ListBox as $k => $v )			{				$SQL_Insert['ReferalQAStatus'] 		= 0;				$SQL_Insert['ReferalUpdateQAUid']   = $this -> getSession("UserId");;				$SQL_Insert['ReferalApprovalTs']    = date('Y-m-d H:i:s'); 								$WHERE['ReferalId']			   = $RefId[$v];								//echo json_encode($WHERE);								if( $this -> set_mysql_update("t_gn_referal",$this -> SQLnull($SQL_Insert),$WHERE) ) 					$_tot++;							}					}							if( $_tot > 0 ) $result = array("result"=>1,'data'=>$_REQUEST);		else			$result = array("result"=>0,'data'=>$_REQUEST);					echo json_encode($result);	}		function Approve()	{		$result  = array("result"=>0,'data'=>$_REQUEST);		$RefId	 = $this->getReferalId();		$ListBox = self::_getListBox();		if(is_array( $ListBox ) ){			$_tot = 0;			foreach( $ListBox as $k => $v )			{				$SQL_Insert['ReferalQAStatus'] 		= 1;				$SQL_Insert['ReferalUpdateQAUid']   = $this -> getSession("UserId");;				$SQL_Insert['ReferalApprovalTs']    = date('Y-m-d H:i:s'); 								$WHERE['ReferalId']			   = $RefId[$v];								//echo json_encode($WHERE);								if( $this -> set_mysql_update("t_gn_referal",$this -> SQLnull($SQL_Insert),$WHERE) ) 					$_tot++;							}						if( $this->getCountReferal() >= 3 )				$this->freePA();		}							if( $_tot > 0 ) $result = array("result"=>1,'data'=>$_REQUEST);		else			$result = array("result"=>0,'data'=>$_REQUEST);					echo json_encode($result);	}		function Update()	{		$result = array("result"=>0,'data'=>$_REQUEST);		$RefId	= $this->getReferalId();		if(is_array( self::_getListBox() ) ){			$_tot = 0;			foreach( self::_getListBox() as $k => $v )			{				$SQL_Insert['ReferalName'] 	   = $this -> escPost("CustomerName_$v");				$SQL_Insert['ReferalPhone1']   = $this -> escPost("PhoneNumber1_$v");				$SQL_Insert['ReferalPhone2']   = $this -> escPost("PhoneNumber2_$v"); 				$SQL_Insert['ReferalPhone3']   = $this -> escPost("PhoneNumber3_$v");				$SQL_Insert['ReferalDOB']	   = $this -> escPost("DOB_$v");				$SQL_Insert['ReferalRelasi'] = $this -> escPost("Relasi_$v");				$SQL_Insert['ReferalAddress']  = $this -> escPost("CustomerAddress_$v");				$SQL_Insert['ReferalUpdatedTs']= date('Y-m-d H:i:s');								$WHERE['ReferalId']			   = $RefId[$v];								//echo json_encode($WHERE);								if( $this -> set_mysql_update("t_gn_referal",$this -> SQLnull($SQL_Insert),$WHERE) ) 					$_tot++;			}					}							if( $_tot > 0 ) $result = array("result"=>1,'data'=>$_REQUEST);		else			$result = array("result"=>0,'data'=>$_REQUEST);					echo json_encode($result);	}		function Save()	{		$result = array("result"=>0,'data'=>$_REQUEST);		if(is_array( self::_getListBox() ) ){			$_tot = 0;			foreach( self::_getListBox() as $k => $v )			{				$SQL_Insert['ReferalCustomerId'] = $this -> CustomerId;				$SQL_Insert['ReferalName'] = $this -> escPost("CustomerName_$v");				$SQL_Insert['ReferalPhone1'] = $this -> escPost("PhoneNumber1_$v");				$SQL_Insert['ReferalPhone2'] = $this -> escPost("PhoneNumber2_$v"); 				$SQL_Insert['ReferalPhone3'] = $this -> escPost("PhoneNumber3_$v");				$SQL_Insert['ReferalDOB']	 = $this -> escPost("DOB_$v");				$SQL_Insert['ReferalRelasi'] = $this -> escPost("Relasi_$v");				$SQL_Insert['ReferalAddress'] = $this -> escPost("CustomerAddress_$v");				$SQL_Insert['ReferalSellerId'] = $this -> getSession("UserId"); 				$SQL_Insert['ReferalCreateTs'] = date('Y-m-d H:i:s');								if( $this -> set_mysql_insert("t_gn_referal",$this -> SQLnull($SQL_Insert)) ) 					$_tot++;			}						$datas = array( 'CustomerWithReferal' => 1);			$where = array( 'CustomerId'=> $this -> CustomerId);			$query = $this -> set_mysql_update('t_gn_customer', $datas, $where);		}							if( $_tot > 0 ) $result = array("result"=>1,'data'=>$_REQUEST);		else			$result = array("result"=>0,'data'=>$_REQUEST);					echo json_encode($result);	}	}	new saveReferal();?>