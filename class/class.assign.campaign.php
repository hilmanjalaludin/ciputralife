<?phprequire(dirname(__FILE__)."/../sisipan/sessions.php");require(dirname(__FILE__)."/../fungsi/global.php");require(dirname(__FILE__)."/../class/MYSQLConnect.php");require(dirname(__FILE__)."/../plugin/lib.form.php");/* * settup campaign by agent By SPV Modul  * author:omens */ class AgentCampaign extends mysql{	  var $JP_Plugin;/** main class of aksesor **/ function AgentCampaign()	{				//print_r($this -> JP_Plugin);		parent::__construct();		$this -> JP_Plugin = new jpForm();		$this -> index();	}/** index of class modul **/ function index()	{		if( $this -> havepost('action'))		{			switch($this -> escPost('action'))			{				case 'modul_agt_campaign' : $this -> ModulAgtCampaign(); break;				case 'modul_agt_active'	  : $this -> ModulAgtActive(); 	 break;				case 'modul_agt_unactive' : $this -> ModulAgtUnActive(); break;			}		}	}	/** ModulAgtActive **/private function ModulAgtActive() { 	$array_post = array('result'=> 0,'Users'=>'','Campaign'=>'');		if( $this -> havepost('getActiveAssign'))	{		$getActiveAssign = explode(',',base64_decode($this -> escPost('getActiveAssign')));				$totals_users = 0;		$totals_campaign = 0;		foreach( $getActiveAssign as $key => $result )		{			$UserByCampaign = explode("_",$result); 			if( count($UserByCampaign)> 1 )			{				$CampaignId = $this -> Entity -> getSpesificCampaign($UserByCampaign[1]);				$UserDetail = $this -> Users -> getUsers($UserByCampaign[0]);				if( $UserDetail -> isAvailable() )				{					$SQL_Insert['AssignSellerId'] = $UserDetail -> getUserId(); 					$SQL_Insert['CampaignId'] 	  = $CampaignId -> result_get_value('CampaignId');					$SQL_Insert['CampaignMode']   = $this -> escPost('ModeActive');					$SQL_Wheres['CampaignMode']   = $this -> escPost('ModeActive');					$SQL_Insert['AssignUpdates']  = date('Y-m-d H:i:s');					$SQL_Wheres['AssignUpdates']  = date('Y-m-d H:i:s');										if( $this -> set_mysql_insert('t_gn_assign_campaign',$SQL_Insert,$SQL_Wheres))					{												$array_post['result'] += 1;						$array_post['Users'][] = $UserDetail -> getFullname(); 						$array_post['Campaign'][] = $CampaignId -> result_get_value('CampaignName');					}				}				}		}			}		echo json_encode($array_post); }	   	/** ModulNoAgtActive **/private function ModulAgtUnActive() { 	$array_post = array('result'=> 0,'Users'=>'','Campaign'=>'');		if( $this -> havepost('getActiveAssign'))	{		$getActiveAssign = explode(',',base64_decode($this -> escPost('getActiveAssign')));				$totals_users = 0;		$totals_campaign = 0;		foreach( $getActiveAssign as $key => $result )		{			$UserByCampaign = explode("_",$result); 			if( count($UserByCampaign)> 1 )			{				$CampaignId = $this -> Entity -> getSpesificCampaign($UserByCampaign[1]);				$UserDetail = $this -> Users -> getUsers($UserByCampaign[0]);				if( $UserDetail -> isAvailable() )				{					$SQL_Insert['AssignSellerId'] = $UserDetail -> getUserId(); 					$SQL_Insert['CampaignId'] 	  = $CampaignId -> result_get_value('CampaignId');					$SQL_Insert['CampaignMode']   = $this -> escPost('ModeActive');					$SQL_Wheres['CampaignMode']   = $this -> escPost('ModeActive');					$SQL_Insert['AssignUpdates']  = date('Y-m-d H:i:s');					$SQL_Wheres['AssignUpdates']  = date('Y-m-d H:i:s');										if( $this -> set_mysql_insert('t_gn_assign_campaign',$SQL_Insert,$SQL_Wheres))					{												$array_post['result'] += 1;						$array_post['Users'][] = $UserDetail -> getFullname(); 						$array_post['Campaign'][] = $CampaignId -> result_get_value('CampaignName');					}				}				}		}			}		echo json_encode($array_post); }	/** get status campaign **/	private function getAssgStatus($Campaign=0, $UserId=0){	$Flags = '';		$sql = " SELECT a.CampaignMode FROM t_gn_assign_campaign a  WHERE a.CampaignId='$Campaign' AND a.AssignSellerId='$UserId'";	$qry = $this -> query($sql);	if( !$qry -> EOF() )	{		$Flags = $qry -> result_get_value('CampaignMode');		}		if( $Flags!='' )	{		switch($Flags){			case 'Y' : return "<span style=\"color:green;font-weight:bold;\">Y</span>"; break;			case 'N' : return "<span style=\"color:red;font-weight:bold;\">N</span>"; break;		}	}	else		return "<span style=\"color:green;font-weight:bold;\">Y</span>";}		/** get post campaign ****/	 private function getPostCampaignId() {	return explode(',',$this -> escPost('CampaignId')); }	 /** get post campaign ****/	 private function getPostTMR() {	return explode(',',$this -> escPost('TmrId')); }	   	/** get count of campaign every Users ***/	 private function getCampaignByAgent() {	$CampaignId = IMPLODE("','",$this -> getPostCampaignId());	$getPostTMR = IMPLODE("','",$this -> getPostTMR());		$sql = " SELECT COUNT(*) size_data, b.CampaignId, a.AssignSelerId			 FROM t_gn_assignment a 			 LEFT JOIN t_gn_customer b on a.CustomerId=b.CustomerId			 WHERE b.CampaignId IN('$CampaignId') ";		// filter data 	if( $this -> havepost('TmrId')) 		$sql.=" AND a.AssignSelerId IN('$getPostTMR') "; 						$sql.=" GROUP BY b.CampaignId, a.AssignSelerId ";	$qry = $this -> query($sql);	foreach( $qry -> result_assoc() as $rows )	{		if( $rows['AssignSelerId']!='' )		{			$datas[$rows['AssignSelerId']][$rows['CampaignId']] += $rows['size_data'];		}	}			return $datas; }	 /* modul agt campaign **/	 function ModulAgtCampaign() {			$content.= " <table border=\"0\" cellspacing=\"0\" width=\"75%\"> ";							foreach( $this -> getCampaignByAgent() as $UserId => $rows )	{		$Users = $this->Users->getUsers($UserId);		$content.= "<tr>";					$content.="<td width=\"20%\" style=\"background-color:#fff;border-bottom:1px solid #000000;font-size:12px;padding-left:5px;padding-right:5px;color:#121286;\">								<img src=\"../gambar/icon/user.gif\"> ".$Users->getUsername()." - ".$Users->getFullname()."</td>";							$content.="<td style=\"border-bottom:1px solid #000;\">";								$content.="<table border=0 width=\"100%\" cellspacing=\"0\" style=\"border-bottom:1px solid #dddddd;border-right:1px solid #dddddd;\">";									$content.="<tr>													<td style=\"height:24px;background-color:#8686ef;border-left:1px solid #FFFDDD;border-top:1px solid #dddddd;text-align:center;\">&nbsp;</td>													<td style=\"height:24px;background-color:#8686ef;border-left:1px solid #FFFDDD;border-top:1px solid #dddddd;color:#FFFFFF;font-weight:bold;\">&nbsp;Campaign Name</td>													<td style=\"height:24px;background-color:#8686ef;border-left:1px solid #FFFDDD;border-top:1px solid #dddddd;color:#FFFFFF;font-weight:bold;text-align:center;\">Size Data</td>													<td style=\"height:24px;background-color:#8686ef;border-left:1px solid #FFFDDD;border-top:1px solid #dddddd;color:#FFFFFF;font-weight:bold;text-align:center;\">Assign</td>												</tr>"; 									foreach( $rows as $CampaignId => $CampaignSizeData)									{										//print_r($this ->JP_Plugin);										$XML = $this->Entity->getSpesificCampaign($CampaignId);										$content.="<tr>													<td style=\"border-left:1px solid #dddddd;border-top:1px solid #dddddd;text-align:center;\">".$this->JP_Plugin->jpResultCheck('set_user_campaign',null,$UserId.'_'.$XML->result_get_value('CampaignId'),NULL)."</td>													<td style=\"border-left:1px solid #dddddd;border-top:1px solid #dddddd;text-align:left;\">".$XML->result_get_value('CampaignName')."</td>													<td style=\"border-left:1px solid #dddddd;border-top:1px solid #dddddd;text-align:center;\">".$CampaignSizeData."</td>													<td style=\"border-left:1px solid #dddddd;border-top:1px solid #dddddd;text-align:center;\">".$this -> getAssgStatus($XML->result_get_value('CampaignId'),$Users -> getUserId())."</td>												  </tr>";									}								$content.="</table><br>";								$content.="</td>";		$content.= "</tr>";		}			$content.="</table>";			echo json_encode( array('content' => $content,'result' => 1) ); }		}new AgentCampaign(true);?>