<?phprequire("../sisipan/sessions.php");require("../fungsi/global.php");require("../class/MYSQLConnect.php");	class SaveCreditShield extends mysql{	var $CustomerId;	var $ClosingId;	var $CampaignId;	var $action;		function SaveCreditShield()	{		parent::__construct();				$this -> action 	= $this -> escPost('action');		$this -> CampaignId = $this -> escPost('CampaignId'); 		$this -> CustomerId = $this -> escPost('CustomerId'); 				if( !empty( $this -> CampaignId ) )		{			$this -> getProductPrefix();		}		}	//////////////////////////////////////		function index()	{		if( $this->havepost('action') )		{			switch($this->action)			{				case 'save_create_policy' : $this -> SaveCreatePolicy(); break;			}		}	}/////		private function FCustomerPolicy()	{		$sql = " select count(a.PolicyAutoGenId) from t_gn_policyautogen a where a.CustomerId='".$this -> CustomerId."'";		$ncust = $this -> valueSQL($sql,__FILE__,__LINE__);		if( $ncust > 0 ) return true;		else return false;	}			/////	private function getProductPrefix()	{		$sql =" select  a.PrefixChar, a.PrefixLength 				from t_gn_productprefixnumber a 				inner join t_gn_product b on a.ProductId=b.ProductId 				left join t_gn_campaignproduct c on a.ProductId=c.ProductId				where c.CampaignId='".$this -> CampaignId."' and a.PrefixFlagStatus=1";								$query  = $this -> execute($sql,__file__,__line__);			$result = $this -> fetcharray($query);			if( $result )			{				$this -> MaxlengthPolicy = $result['PrefixLength'];				$this -> PolicyPrefix 	 = $result['PrefixChar'];			}	}		/// ClosingNumber		private function ClosingNumber($policyNumber="")	{		$policeLastId = $policyNumber;		if( !empty( $policeLastId) )		{			$result = substr( $this -> PolicyPrefix,0,strlen($this -> PolicyPrefix) - (strlen($policeLastId)) );			$result.= $policeLastId; 							if( strlen($result) == $this -> MaxlengthPolicy)				{					return $result;				}				else{ return false; }		}		else{ return true;  }	}		private function getPolicyNumber($PolicyNumber)	{		$sql = " select count(a.PolicyId) as cnt from t_gn_policy a where a.PolicyNumber='$PolicyNumber'";		if( $this -> valueSQL($sql,__FILE__,__LINE__) > 0 ) return true;		else			return false;	}	/// priavte generate ClosingId		private function getClosingId()	{		if( !empty($this -> CustomerId) )		{			if( $this -> FProductPolicy() )			{				if( $this -> FCustomerPolicy() )				{					$sql =" select a.PolicyNumber from t_gn_policyautogen a where a.CustomerId='".$this -> CustomerId."'";					$closeId = $this -> valueSQL($sql,__FILE__,__LINE__);				}				else{					$sql = " select (max(a.PolicyLastNumber)+1) from t_gn_policyautogen a where a.ProductId='".$this -> ProductIdByCampaign()."'";					$res = $this ->valueSQL($sql,__FILE__,__LINE__);					if( ($res!='') )					{						$closeId = $this -> ClosingNumber($res);						if( $closeId )						{							$SQL_Insert['CustomerId'] 	   = $this -> CustomerId; 							$SQL_Insert['ProductId'] 	   = $this -> ProductIdByCampaign(); 							$SQL_Insert['PolicyNumber']    = $closeId;							$SQL_Insert['PolicyLastNumber']= $res;								$this -> set_mysql_insert("t_gn_policyautogen", $SQL_Insert, $SQL_Insert);						}						}				}			}			else			{				$sql = " SELECT max(a.PolicyLastNumber) from t_gn_policyautogen a 						 WHERE a.CustomerId='".$this -> CustomerId."' 						 and a.ProductId='".$this -> ProductIdByCampaign()."'";						 				$res = ($this ->valueSQL($sql,__FILE__,__LINE__)+1);				if($res!='')				{					$closeId = $this -> ClosingNumber($res);					if($closeId)					{						$SQL_Insert['CustomerId'] 	   = $this -> CustomerId; 						$SQL_Insert['ProductId'] 	   = $this -> ProductIdByCampaign(); 						$SQL_Insert['PolicyNumber']    = $closeId;						$SQL_Insert['PolicyLastNumber']= $res;							$this -> set_mysql_insert("t_gn_policyautogen", $SQL_Insert, $SQL_Insert);					}				}			}						return $closeId;		}	}			///	private function FProductPolicy()	{		$sql = " select count(a.PolicyAutoGenId) from t_gn_policyautogen a 				 where a.productId=".$this -> ProductIdByCampaign()."";				 		$ncust = $this -> valueSQL($sql,__FILE__,__LINE__);		if( $ncust > 0 ) return true;		else return false;	}		/////	private function ProductIdByCampaign()	{		$sql =" SELECT a.ProductId from t_gn_productprefixnumber a 				INNER JOIN t_gn_product b on a.ProductId=b.ProductId 				LEFT JOIN t_gn_campaignproduct c on a.ProductId=c.ProductId				WHERE c.CampaignId='".$this -> CampaignId."' and a.PrefixFlagStatus=1";							return $this -> valueSQL($sql,__FILE__,__LINE__);	}		//////////////////////////////////////		function SaveCreatePolicy()	{		$result = array('result'=>0, 'closingnumber' => 0 );		$v_unix_number = $this -> getClosingId();		if( !empty($v_unix_number) )		{			if( !$this -> getPolicyNumber($v_unix_number) )			{				$SQL_Insert = array();				$SQL_Insert['PolicyNumber'] = $v_unix_number; 				$SQL_Insert['PolicySalesDate'] = date('Y-m-d H:i:s'); 				$SQL_Insert['PolicyEffectiveDate'] = date('Y-m-d H:i:s'); 								$qry = $this -> set_mysql_insert('t_gn_policy',$SQL_Insert);				if( $qry )				{					$get_insert_id = $this -> get_insert_id();					if( !empty( $get_insert_id ) )					{						$sql = "select * from t_gn_customer a where a.CustomerId ='".$this -> CustomerId."'";						$qry = $this -> query($sql);						if( $qry -> result_num_rows() > 0 )						{							$SQL_Insert2['PolicyId'] 				=  $get_insert_id;							$SQL_Insert2['CustomerId'] 				=  $qry -> result_get_value('CustomerId');							$SQL_Insert2['InsuredDOB'] 				=  $qry -> result_get_value('CustomerDOB');							$SQL_Insert2['InsuredAddressLine1'] 	=  $qry -> result_get_value('CustomerAddressLine1');							$SQL_Insert2['InsuredAddressLine2'] 	=  $qry -> result_get_value('CustomerAddressLine2');							$SQL_Insert2['InsuredAddressLine3'] 	=  $qry -> result_get_value('CustomerAddressLine3');							$SQL_Insert2['InsuredAddressLine4'] 	=  $qry -> result_get_value('CustomerAddressLine4');							$SQL_Insert2['InsuredCity'] 			=  $qry -> result_get_value('CustomerCity');							$SQL_Insert2['InsuredZipCode'] 			=  $qry -> result_get_value('CustomerCity');							$SQL_Insert2['InsuredHomePhoneNum'] 	=  $qry -> result_get_value('CustomerHomePhoneNum');							$SQL_Insert2['InsuredMobilePhoneNum'] 	=  $qry -> result_get_value('CustomerMobilePhoneNum');							$SQL_Insert2['InsuredOfficePhoneNum'] 	=  $qry -> result_get_value('CustomerWorkPhoneNum');							$SQL_Insert2['InsuredFaxNum'] 		  	=  $qry -> result_get_value('CustomerFaxNum');							$SQL_Insert2['InsuredEmail'] 		  	=  $qry -> result_get_value('CustomerEmail');							$SQL_Insert2['InsuredCreatedTs'] 	  	=  date('Y-m-d H:i:s'); 							$SQL_Insert2['InsuredUpdatedTs'] 	  	=  date('Y-m-d H:i:s'); 														if( $this -> set_mysql_insert('t_gn_insured',$SQL_Insert2) )							{								$result = array('result'=>1, 'closingnumber' => $v_unix_number );							}						}					}					}			}			else{				$result = array('result'=>2, 'closingnumber' => $v_unix_number );			}			}				echo json_encode($result);	}	/** get dob **/	function getResultDOB()	{		if( $this -> havepost('CustomerDob') )		{			$tgl = EXPLODE("/",$_REQUEST['CustomerDob']);			$yy  = $tgl[2];			$mm  = $tgl[1];			$dd  = $tgl[0];						if( count($CustomerDob)){				return $dd.'-'.$mm.'-'.$yy;			}			else				return NULL;		}			}	}$SaveCreditShield = new SaveCreditShield();$SaveCreditShield -> index();?>	