<?php		require("../fungsi/global.php");	require("../sisipan/sessions.php");	require("../class/MYSQLConnect.php");	require("../class/class.telnet.socket.php");	require("../class/lib.form.php");			class ExtensionSystem extends mysql{		var $action;		var $extensionId;		var $extSystem;		var $Forms;		var $PBX;						function __construct(){			parent::__construct();			if( $this->havepost('action')):				$this -> action 		= $this->escPost('action');				$this -> extensionId  	= $this->escPost('extension');				$this -> Forms 			= new jpForm(true);				$this -> PBX	 		= new socketTelnet();				$this -> getExtension();			endif;		}						/* function set style css **/		function setCss(){?>						<!-- start: css -->				<style>					.select { border:1px solid #dddddd;width:190px;font-size:11px;height:20px;background-color:#fffccc;}					.input_text { border:1px solid #dddddd;width:190px;font-size:11px;height:16px;background-color:#fffccc;}					.text_header { text-align:right;color:red;font-size:12px;}					.select_multiple { border:1px solid #dddddd;height:100px;font-size:11px;background-color:#fffccc;}					.textarea{border:1px solid #dddddd;width:190px;background-color:#fffccc;}				</style>							<!-- stop: css -->		<?php }				function InitExtSystem(){						if( $this->havepost('action')){				switch($this -> action){					case 'edit_extension_tpl':  $this -> EditTplExtension(); 		break;					case 'add_extension_tpl' :  $this -> addTplExtension(); 		break;					case 'rel_extension_tpl' :  $this -> releaseTplExtension(); 	break;					case 'rel_extension_exe' :  $this -> PBXSyntax(); 				break;					case 'upl_extension_tpl' :  $this -> UploadTplExtension();   	break;					case 'upl_extension_exe' :  $this -> UploadExtensionExe(); 		break;					case 'del_extension_exe' :  $this -> DeleteExtensionExe(); 		break;					case 'add_extension_exe' :  $this -> AddExtensionExe(); 		break;					case 'upd_extension_exe' :  $this -> UpadateExtensionExe(); 	break;					case 'ctb_restart_exe'	 :  $this -> CTBRestart(); 	break; 				}			}				}						function CTBRestart(){			$cmd = " service centerback restart";			$result = exec($cmd);			echo $result;				}				function UpadateExtensionExe(){						$sql['pbx']  		 = $this->escPost('ext_pbx'); 			$sql['ext_number'] 	 = $this->escPost('ext_number'); 			$sql['ext_desc'] 	 = $this->escPost('ext_desc');			$sql['ext_type'] 	 = $this->escPost('ext_type');			$sql['ext_status'] 	 = $this->escPost('ext_status');			$sql['ext_location'] = $this->escPost('ext_location');						$where['id'] = $this->escPost('id');			$query = $this ->set_mysql_update('cc_extension_agent',$sql,$where);				if( $query ) 				echo 1;			else 				echo 0;			}				function AddExtensionExe(){						$sql['pbx']  		 = $this->escPost('ext_pbx'); 			$sql['ext_number'] 	 = $this->escPost('ext_number'); 			$sql['ext_desc'] 	 = $this->escPost('ext_desc');			$sql['ext_type'] 	 = $this->escPost('ext_type');			$sql['ext_status'] 	 = $this->escPost('ext_status');			$sql['ext_location'] = $this->escPost('ext_location');						$where['ext_number'] = $this->escPost('ext_number');			$where['ext_desc'] 	 = $this->escPost('ext_desc');			$where['ext_type'] 	 = $this->escPost('ext_type');			$where['ext_status'] = $this->escPost('ext_status');			$where['ext_location'] = $this->escPost('ext_location');						$query = $this ->set_mysql_insert('cc_extension_agent',$sql,$where);				if( $query ) 				echo 1;			else 				echo 0;			}						function DeleteExtensionExe(){			$extId = explode(",",$this -> extensionId);			$totId = 0;						foreach($extId as $k=>$e){				$sql = " DELETE FROM cc_extension_agent WHERE id = '".$e."'";				$res = $this ->execute($sql,__FILE__,__LINE__);				if( $res ) $totId+=1;							} 						echo $totId;		}						function getPBX(){			$datas = array();			$sql   = "select a.pbx, a.set_value from cc_pbx_settings a where LENGTH(set_value)>10 ";			$qry   = $this ->execute($sql,__FILE__,__LINE__);			while( $row = $this->fetchrow($qry)){				$datas[$row -> pbx] = $row -> set_value;			}			return $datas;		}				function UploadExtensionExe(){			ini_set("memory_limit", "1024M");			require_once("class.import.excel.php");													$FILE_EXT = $_FILES['fileToupload'];				if( !copy($FILE_EXT['tmp_name'], '../upload/'.$FILE_EXT['name'])){					echo "Failed!";				}				else{									if( $_REQUEST['mode'] =='truncate'): $this->execute('TRUNCATE cc_extension_agent',__FILE__,__LINE__); endif;										$excel 		= new Spreadsheet_Excel_Reader('../upload/'.$FILE_EXT['name'],true,'mb');					$rows 		= $excel -> rowcount($sheet_index=0);					$tot_rows 	= 0;										for( $i=2; $i<=$rows; $i++){											$sql['pbx']  		 = $excel -> val($i,1); 						$sql['ext_number'] 	 = $excel -> val($i,2); 						$sql['ext_desc'] 	 = $excel -> val($i,3);						$sql['ext_type'] 	 = $excel -> val($i,4);						$sql['ext_status'] 	 = $excel -> val($i,5);						$sql['ext_location'] = $excel -> val($i,6);												/* where **/													$where['pbx'] 		   = $excel -> val($i,1); 							$where['ext_desc'] 	   = $excel -> val($i,3);							$where['ext_type'] 	   = $excel -> val($i,4);							$where['ext_status']   = $excel -> val($i,5);							$where['ext_location'] = $excel -> val($i,6);														$query = $this ->set_mysql_insert('cc_extension_agent',$sql,$where);													if( $query ) { 							$tot_rows+=1;						}					}					 					echo "Success, Totals Upload Rows ( $tot_rows ) ";				}			}				function PBXSyntax()		{			if( $this->havepost('ext_number') ){					$socketString = "rel-station\r\n"."ext: ".$this->escPost('ext_number')."\r\n\r\n";					$this -> PBX -> set_fp_command($socketString);					if($this -> PBX -> send_fp_comand())					{						echo $this -> PBX -> get_fp_response();					}					else						echo 0;			}			else{				echo "False";			}		}						function getExtension(){			$sql = " select						a.id as extId,						a.ext_number as extNumber, 						b.set_value as extPbx,						a.ext_desc as extDesc,						a.ext_type as extType,						a.ext_status as extStatus,						a.ext_location as extLocation						 from cc_extension_agent a left join cc_pbx_settings b						on a.pbx=b.id where a.id='".$this -> extensionId."'";			$query = $this ->execute($sql,__FILE__,__LINE__);						if( $query ):				$this ->extSystem = $this ->fetchrow($query); 			endif;			}				function UploadTplExtension(){			$this->setCss();		?>			<fieldset style="border:1px solid #dddddd;margin-top:10px;margin-left:10px;">				<legend > <b>Upload Extension</b></legend>					<div class="box-shadow">						<form action="javascript:void(0);"  id="uploadform" method="POST" >							<table cellpadding="12px;">							<tr>								<td class="text_header"> Mode </td>								<td style="color:#bbb000;">									<?php $this -> Forms->jpRadio('modus_action', $css="", $value="truncate",null, 0, "Truncate Data"); ?>									&nbsp;&nbsp;									<?php $this -> Forms->jpRadio('modus_action', $css="", $value="update",null, 1, "Replace Data"); ?>																	</td>							</tr>							<tr>								<td class="text_header">File To Upload (*.xls)</td>								<td><input  type="file" name="fileToupload[]" id="fileToupload"  size="47" style="background-color:#eeeeee;font-size:11px;border:1px solid #dddddd;height:24px;width:300px;" onChange="JavaScript:AjaxUploads.UploadInfo();"/></td>								<td>									<fieldset class="box-shadow" style="display:none;">										<div id="fileName" style="font-family:Trebuchet MS;color:red;line-height:20px;"></div>										<div id="fileSize" style="font-family:Trebuchet MS;color:red;line-height:20px;"></div>										<div id="fileType" style="font-family:Trebuchet MS;color:red;line-height:20px;"></div>										<div id="progressNumber"></div>										<progress id="prog" value="0" max="100.0"></progress>																		</fieldset>									<span id="loadings_gambar"  style="display:none;color:red;"> <img src="../gambar/loading.gif"> loading...</span>								</td>							</tr>							<tr>								<td>&nbsp;</td>								<td colspan="2">									<a href="javascript:void(0);" class="sbutton" onclick="Upload();"><span>&nbsp;Upload</span></a>								</td>							</tr>								</table>						</form>					</div>			</fieldset>				<?php		}						function addTplExtension(){			$this->setCss();		?>			<fieldset style="border:1px solid #dddddd;margin-top:10px;margin-left:10px;">				<legend > <b>Edit Extension</b></legend>					<div class="box-shadow">						<table cellpadding="8px;">							<tr>								<td class="text_header">Extension Number</td>								<td><?php $this -> Forms->jpInput('ext_number','input_text',$this -> extSystem -> extNumber );?></td>							</tr>														<tr>								<td class="text_header">IP PBX </td>								<td><?php $this -> Forms->jpCombo('ext_pbx','select',$this -> getPBX(), $this -> extSystem -> extPbx );?></td>							</tr>														<tr>								<td class="text_header">Extension Description </td>								<td><?php $this -> Forms->jpTextarea('ext_desc','textarea',$this -> extSystem -> extDesc );?></td>							</tr>														<tr>								<td class="text_header">Extension Type</td>								<td><?php $this -> Forms->jpCombo('ext_type','select',array(0,1,2,3,4), $this -> extSystem -> extType );?></td>							</tr>														<tr>								<td class="text_header">Extension Status</td>								<td><?php $this -> Forms->jpCombo('ext_status','select',array(0,1),$this -> extSystem -> extStatus );?></td>							</tr>														<tr>								<td class="text_header">Extension Location</td>								<td><?php $this -> Forms->jpInput('ext_location','input_text',$this -> extSystem -> extLocation );?></td>							</tr>							<tr>								<td>&nbsp;</td>								<td>									<a href="javascript:void(0);" class="sbutton" onclick="saveExtension();"><span>&nbsp;Save</span></a>								</td>							</tr>													</table>					</div>			</fieldset>				<?php		}				function EditTplExtension(){			$this->setCss();		?>			<fieldset style="border:1px solid #dddddd;margin-top:10px;margin-left:10px;">				<legend > <b>Edit Extension</b></legend>					<div class="box-shadow">						<table cellpadding="8px;">							<input type="hidden" id="extId" name="extId" value="<?php echo $this -> extSystem ->extId; ?>">							<tr>								<td class="text_header">Extension Number</td>								<td><?php $this -> Forms->jpInput('ext_number','input_text',$this -> extSystem -> extNumber );?></td>							</tr>														<tr>								<td class="text_header">IP PBX </td>								<td><?php $this -> Forms->jpCombo('ext_pbx','select',$this -> getPBX(), $this -> extSystem -> extPbx );?></td>							</tr>														<tr>								<td class="text_header">Extension Description </td>								<td><?php $this -> Forms->jpTextarea('ext_desc','textarea',$this -> extSystem -> extDesc );?></td>							</tr>														<tr>								<td class="text_header">Extension Type</td>								<td><?php $this -> Forms->jpCombo('ext_type','select',array(0,1,2,3,4), $this -> extSystem -> extType );?></td>							</tr>														<tr>								<td class="text_header">Extension Status</td>								<td><?php $this -> Forms->jpCombo('ext_status','select',array(0,1),$this -> extSystem -> extStatus );?></td>							</tr>														<tr>								<td class="text_header">Extension Location</td>								<td><?php $this -> Forms->jpInput('ext_location','input_text',$this -> extSystem -> extLocation );?></td>							</tr>							<tr>								<td>&nbsp;</td>								<td>									<a href="javascript:void(0);" class="sbutton" onclick="UpdateExtension();"><span>&nbsp;Update</span></a>								</td>							</tr>													</table>					</div>			</fieldset>				<?php		}				function releaseTplExtension(){			$this->setCss();		?>			<fieldset style="border:1px solid #dddddd;margin-top:10px;margin-left:10px;">				<legend > <b>Release Extension</b></legend>					<div class="box-shadow">						<table cellpadding="8px;">							<tr>								<td class="text_header">Extension Number</td>								<td><?php $this -> Forms->jpInput('ext_number','input_text',$this -> extSystem -> extNumber );?> <span id="loading_image" style="color:red;"></span></td>							</tr>							<tr>								<td>&nbsp;</td>								<td>									<a href="javascript:void(0);" class="sbutton" onclick="ReleaseExt();"><span>&nbsp;Release</span></a>								</td>							</tr>													</table>					</div>			</fieldset>				<?php		}				}		$UserSystem = new ExtensionSystem();	$UserSystem -> InitExtSystem();?>