<?phprequire(dirname(__FILE__)."/../sisipan/sessions.php");require(dirname(__FILE__)."/../fungsi/global.php");require(dirname(__FILE__)."/../class/MYSQLConnect.php");require(dirname(__FILE__)."/../class/lib.form.php");require(dirname(__FILE__)."/../class/class_export_excel.php");define('USER_LEVEL_ADMIN',1);define('USER_LEVEL_MGR',2);define('USER_LEVEL_SPV',3);define('USER_LEVEL_AGENT',4);class TarikData extends mysql{	var $excel;		function TarikData()	{		parent::__construct();				$this -> Form  = new jpForm();		if( $this -> havepost('action'))		{			switch( $_REQUEST['action'])			{				case 'get_list_campaign' : $this -> getCampaignList();  break;				case 'get_list_result'   : $this -> getResultList(); 	break;				case 'get_list_user'	 : $this -> getUersList(); 		break;				case 'get_list_low_user' : $this -> getUersLowList(); 	break;				case 'get_size_data' 	 : $this -> getSizeData(); 		break;				case 'save_data_tmp'	 : $this -> saveTmpSizeData(); 	break;				case 'get_content_table' : $this -> contentTables(); 	break; 				case 'delete_temp_id'	 : $this -> removeSessionTmp(); break;				case 'download_data'	 : $this -> DownloadData(); 	break;					case 'get_list_type'	 : $this -> getListType(); 		break;					 			}		}	}/** download data **/	function DownloadData()	{				$SesionTempId = EXPLODE(',', base64_decode($_REQUEST['tmp_session_id']));		$SesionTempIn = IMPLODE("','",$SesionTempId);			/** created object excel ***/				$this -> excel = new excel();			/** created headerr excel data ***/			$xlsRows = 0;		$this -> excel -> xlsWriteHeader("AJMI_DOWNLOAD_DATA_".time());		/** setup query ****/			$sql = " select 					e.CampaignName, c.CustomerNumber,					c.GenderId, c.CustomerCardType,					c.CustomerFirstName, c.CallReasonId,					c.CustomerDOB, c.SellerId,					c.CustomerAddressLine1, c.CustomerAddressLine2,					c.CustomerAddressLine3, c.CustomerAddressLine4,					c.CustomerCity, c.CustomerZipCode,					c.CustomerHomePhoneNum, c.CustomerMobilePhoneNum,					c.CustomerWorkPhoneNum, g.id as UserName,					g.full_name as FullName, f.CallReasonCategoryName, d.CallReasonDesc,					a.tmp_id as SessionTmpId, c.CustomerId 				from t_gn_tmp_tarik_id a 				left join t_gn_tmp_tarik_detail b on a.tmp_id=b.tmp_tarik_id				left join t_gn_customer c on b.CustomerId=c.CustomerId				left join t_lk_callreason d on c.CallReasonId=d.CallReasonId				left join t_gn_campaign e on c.CampaignId=e.CampaignId				left join t_lk_callreasoncategory f on d.CallReasonCategoryId=f.CallReasonCategoryId				left join tms_agent g on c.SellerId=g.UserId				where a.tmp_id IN('".$SesionTempIn."') ";				 		$qry = $this -> query($sql);			/** created header by rows query ***/			$xlsCols = 0;		foreach( $qry -> result_field_name() as $cols_name )		{				if( ($cols_name!='SessionTmpId') && ($cols_name!='CustomerId') )			{				$this -> excel -> xlsWriteLabel($xlsRows,$xlsCols,$cols_name);				$xlsCols++;			}			}			/** created content data **/			$xlsRows = 1;		foreach( $qry -> result_assoc() as $rows )		{			$position = 0;			foreach( $qry -> result_field_name() as $cols )			{				if( ($cols!='SessionTmpId') && ($cols!='CustomerId') )				{					$this -> excel -> xlsWriteLabel($xlsRows, $position, $rows[$cols]);					$position++;				}				}						$sql = " UPDATE t_gn_tmp_tarik_detail a SET a.IsDownload='Y' WHERE a.tmp_tarik_datail_id='".$rows['SessionTmpId']."'";			if( $this -> execute($sql,__FILE__,__LINE__) )			{				$sql = " UPDATE t_gn_tmp_tarik_id a  SET a.tmp_size_data = ((a.tmp_size_data)-1) WHERE a.tmp_id='".$rows['SessionTmpId']."'";				$this -> execute($sql,__FILE__,__LINE__);									/* new query session ******************************************************************/								$sql = "select * from t_gn_assignment a inner join t_gn_customer b on a.CustomerId=b.CustomerId where a.CustomerId='".$rows['CustomerId']."' ";				$qry = $this -> query($sql);				if( !$qry -> EOF() )				{						$SQL_log['SessionTmpId'] 		= $rows['SessionTmpId'];					$SQL_log['CustomerId'] 			= $qry -> result_get_value('CustomerId');					$SQL_log['AssignAdminId'] 		= $qry -> result_get_value('AssignAdmin');					$SQL_log['AssignManagerId'] 	= $qry -> result_get_value('AssignMgr');					$SQL_log['AssignSupervisorId'] 	= $qry -> result_get_value('AssignSpv');					$SQL_log['AssignSellerId'] 		= $qry -> result_get_value('AssignSelerId');					$SQL_log['CustomerNumber']		= $qry -> result_get_value('CustomerNumber');					$SQL_log['CreatedTs'] 			= date('Y-m-d H:i:s');										/* insert to log *****************************************************************/										$this -> set_mysql_insert('t_gn_tmp_tarik_log',$SQL_log);				}							}								$xlsRows++; 		}				$this -> excel -> xlsClose();	}			/** functio  get Mgr Id ****/			function getMgrByUser($UserId)	{		$sql = " select mgr_id from tms_agent  where  UserId='$UserId'	";		return $this -> valueSQL($sql);	}	/** functio  get SpvId ****/				function getSpvIdByUser($UserId)	{		$sql = " select spv_id from tms_agent  where UserId='$UserId'	";		return $this -> valueSQL($sql);	}		/** user select **/	private function UserSelect()	{		$list_user = explode(",",$_REQUEST['distribute_user_list']);		if( $list_user )		{			return $list_user;		}	}		/** distribusi type is manual data ****/	function get_json_array()	{		if( $this -> havepost('distribute_user_list') )		{			return json_decode(str_replace("\\","", $_REQUEST['distribute_user_list']),true);		}		}	/** name data privilege **/	function getNameLabel($label)	{		$sql = " select a.name from tms_agent_profile a where a.id='$label'";		$qry = $this -> query($sql);		return $qry -> result_singgle_value();	}	/** removeSessionTmp **/	function removeSessionTmp()	{		$SessionTmpId = explode(",",$_REQUEST['temp_list_id']);		$total_deleted = 0;				foreach( $SessionTmpId as $k => $rows )		{			if( $this -> execute("DELETE FROM t_gn_tmp_tarik_detail WHERE tmp_tarik_id='$rows'",__FILE__,__LINE__) )			{				$result = $this -> execute("DELETE FROM t_gn_tmp_tarik_id WHERE tmp_id='$rows'",__FILE__,__LINE__);				if( $result )				{					$total_deleted++;				}			}		}				if( $total_deleted > 0 ) 			echo json_encode(array('result'=>1));		else 			echo json_encode(array('result'=>0));	}		/** contentTables **/function contentTables(){		$content = "<table class=\"custom-grid\" cellspacing=\"0\" border=\"0\" width=\"99%\" align=\"left\" style=\"background-color:#FFFFFF;\">				<thead>					<tr>						<th class=\"custom-grid th-first\" width=\"5%\"><a href=\"javascript:void(0);\" onclick=\"doJava.checkedAll('tmp_list_id');\" style=\"text-decoration:none;\"> # </a></th>						<th class=\"custom-grid th-middle\" width=\"5%\">&nbsp;No </th>						<th class=\"custom-grid th-middle\" align=\"left\">&nbsp;Session Temporary </th>						<th class=\"custom-grid th-middle\" align=\"center\">&nbsp;Data Size </th>						<th class=\"custom-grid th-middle\" align=\"left\">&nbsp;User Created </th>						<th class=\"custom-grid th-lasted\" align=\"center\">&nbsp;Created Date </th>					</tr> 				</thead> ";				/** settup sql ***********************/		$sql = " SELECT a.*, b.id, b.full_name 			 FROM t_gn_tmp_tarik_id a 			 LEFT JOIN tms_agent b  on a.tmp_created_by=b.UserId 			 WHERE a.tmp_created_by='".$_SESSION['UserId']."'";		 	$qry = $this -> query($sql);			if( $qry -> result_num_rows() > 0 )	{		$num_row = 1;		foreach($qry -> result_assoc() as $rows )		{			$content.= "<tr class=\"onselect\">							<td class=\"content-first\"  align=\"center\">".$this -> Form -> jpResulCheck('tmp_list_id',NULL,$rows['tmp_id'])."</td>							<td class=\"content-middle\" align=\"center\">".$num_row."</td>							<td class=\"content-middle\" align=\"left\">".$rows['tmp_session_id']."</td>							<td class=\"content-middle\" align=\"center\">".$rows['tmp_size_data']."</td>							<td class=\"content-middle\" align=\"left\">".$rows['full_name']."</td>							<td class=\"content-lasted\" align=\"center\">".$this -> Date ->indonesia($rows['tmp_created_ts'])."</td>						</tr> ";			$num_row++;					}	}		$content.="</table>";		//echo $content;	echo json_encode(array('result'=>1,'tables' => $content ));}				/** saveTmpSizeData **/	function saveTmpSizeData()	{		$arr_result = array('result'=>0,'total_tmp_save'=>0);		if( $this -> havepost('sql_code_id') )		{			$query = $this -> query($_REQUEST['sql_code_id']);			if( $query -> result_num_rows() > 0 )			{				$SQL_tmp['tmp_session_id'] = md5(rand(time()));				$SQL_tmp['tmp_code_sql']   = $query -> result_str_query();				$SQL_tmp['tmp_size_data']  = $query -> result_num_rows();				$SQL_tmp['tmp_created_ts'] = date('Y-m-d H:i:s');				$SQL_tmp['tmp_created_by'] = $_SESSION['UserId'];								if( $this -> set_mysql_insert('t_gn_tmp_tarik_id',$SQL_tmp) )				{					$sql_tmp_id = $this -> get_insert_id(); 					$tot_tmp_rows = 0;					foreach( $query -> result_assoc()  as $rows )					{						$SQL_tmp_detail['tmp_tarik_id'] 	 = $sql_tmp_id;						$SQL_tmp_detail['CustomerId'] 		 = $rows['CustomerId'];						$SQL_tmp_detail['CampaignId'] 		 = $rows['CampaignId'];						$SQL_tmp_detail['CreatedTs'] 		 = date('Y-m-d H:i:s');						$SQL_tmp_detail['AssignId']			 = $rows['AssignId'];						$SQL_tmp_detail['AssignAdminId'] 	 = $rows['AssignAdmin'];						$SQL_tmp_detail['AssignManagerId']   = $rows['AssignMgr'];						$SQL_tmp_detail['AssignSupervisorId']= $rows['AssignSpv'];						$SQL_tmp_detail['AssignSellerId']	 = $rows['AssignSelerId'];						$SQL_tmp_detail['Distribute'] 		 = 'N';												if( $this -> set_mysql_insert('t_gn_tmp_tarik_detail',$SQL_tmp_detail) ){							$tot_tmp_rows++;						}					}										if( $tot_tmp_rows > 0 )					{						$arr_result = array('result'=>1, 'total_tmp_save' => $tot_tmp_rows );					}					}			}			}				echo json_encode($arr_result);	}	/** function get camppign inType **/	private function getCampaignInType()	{		if( $this -> havepost('campaign_name_id'))		{			$campaign_name_id  = explode(',',$_REQUEST['campaign_name_id']);			if( is_array($campaign_name_id) )			{				return implode("','",$campaign_name_id);			}		}	}	/** function get camppign inType **/	private function getReasonInType()	{		if( $this -> havepost('reason_name_id'))		{			$reason_name_id  = explode(',',$_REQUEST['reason_name_id']);			if(is_array($reason_name_id) )			{				return implode("','",$reason_name_id );			}		}	}/** function get camppign inType **/	private function getTopLevelUerInType()	{		if( $this -> havepost('top_level_user'))		{			$top_level_user  = explode(',',$_REQUEST['top_level_user']);			if(is_array($top_level_user) )			{				return implode("','",$top_level_user );			}		}	}/** function get camppign inType **/	private function getSecondLevelUserInType()	{		if( $this -> havepost('second_level_user'))		{			$second_level_user  = explode(',',$_REQUEST['second_level_user']);			if(is_array($second_level_user) )			{				return implode("','",$second_level_user );			}		}	}		/** function get camppign inType **/	private function getThreeLevelUserInType()	{		if( $this -> havepost('three_level_user') )		{			$three_level_user  = explode(',',$_REQUEST['three_level_user']);			if( is_array($three_level_user) )			{				return implode("','",$three_level_user );			}		}	}			/** get size data bay filter **/		function getSizeData()	{		$value_tot_id = 0;				if( $this -> havepost('campaign_name_id') )		{			$sql = " SELECT a.*, b.*, c.*  					 FROM t_gn_customer a 					 LEFT JOIN t_gn_assignment b ON a.CustomerId=b.CustomerId					 LEFT JOIN t_gn_campaign c ON a.CampaignId=c.CampaignId					 WHERE a.CallReasonId IS NOT NULL ";					 					 		/* get 	my datas **/						switch($_SESSION['handling_type'])			{				case USER_LEVEL_ADMIN : $sql.= " AND b.AssignAdmin IN('".$_SESSION['UserId']."') "; break;				case USER_LEVEL_MGR   : $sql.= " AND b.AssignMgr IN('".$_SESSION['UserId']."') "; break;				case USER_LEVEL_SPV   : $sql.= " AND b.AssignSpv IN('".$_SESSION['UserId']."') "; break;			}						if( $this -> havepost('campaign_name_id') 	&& !empty($_REQUEST['campaign_name_id'])) 	$sql.=" AND c.CampaignNumber IN('".$this -> getCampaignInType()."')"; 			if( $this -> havepost('reason_name_id') 	&& !empty($_REQUEST['reason_name_id'])) 	$sql.=" AND a.CallReasonId IN('".$this -> getReasonInType()."')"; 								/** top level **/					if( $this -> havepost('top_level_user') && !empty($_REQUEST['top_level_user']) )			{ 				switch($_SESSION['handling_type'])				{					case USER_LEVEL_ADMIN : $sql.=" AND b.AssignMgr IN('".$this -> getTopLevelUerInType()."')"; break;					case USER_LEVEL_MGR   : $sql.=" AND b.AssignSpv IN('".$this -> getTopLevelUerInType()."')"; break;					case USER_LEVEL_SPV   : $sql.=" AND b.AssignSelerId IN('".$this -> getTopLevelUerInType()."')"; break;				}			}						/** seconds **/			if( $this -> havepost('second_level_user')  && !empty($_REQUEST['second_level_user']) )			{				switch($_SESSION['handling_type'])				{					case USER_LEVEL_ADMIN : $sql.=" AND b.AssignSpv IN('".$this -> getSecondLevelUserInType()."')"; break;					case USER_LEVEL_MGR   : $sql.=" AND b.AssignSelerId IN('".$this -> getSecondLevelUserInType()."')"; break;				}			}					/** three **/					if( $this -> havepost('three_level_user') 	&& !empty($_REQUEST['three_level_user']))			{				switch($_SESSION['handling_type'])				{					case USER_LEVEL_ADMIN : $sql.=" AND b.AssignSelerId IN('".$this -> getThreeLevelUserInType()."')"; break;					case USER_LEVEL_MGR : $sql.=" AND b.AssignSelerId IN('".$this -> getThreeLevelUserInType()."')"; break;				}			}											/** get handle **/						$query =  $this -> query($sql);			//echo $query -> result_str_query();						if( $query -> result_num_rows() > 0 )			{				$value_sql_id = $query -> result_str_query();				$value_tot_id = $query -> result_num_rows();			}						echo json_encode(array('result'=>1, 'code'=>$value_sql_id, 'total_rows'=>$value_tot_id));		}			else{			echo json_encode(array('result'=>1, 'code'=>'', 'total_rows'=>0));		}	}	/** show user **/	////////////////////////////////////////>>>>>>>>>>>>>>>>>>>>>		function getUersLowList()	{		$UserCheckList = explode(',',$_REQUEST['UserId']);		if( is_array( $UserCheckList) )		{			$new_user_list = implode("','",$UserCheckList);						switch($_REQUEST['Handle'])			{				case 2 : 					$sql = "select a.*, b.name as group_profile from tms_agent a 							left join tms_agent_profile b on a.profile_id=b.id 							where a.handling_type='3' 							AND a.mgr_id IN('".$new_user_list."')";				break;								case 3 : 					$sql = "select a.*, b.name as group_profile from tms_agent a 							left join tms_agent_profile b on a.profile_id=b.id 							where a.handling_type='4' AND a.spv_id IN('".$new_user_list."')";				break;								case 3 : break;			}							$html_legend = ''; $html_insert = ''; $html_count  = 0;			if( $sql!='' )			{				$qry = $this -> query($sql);				foreach( $qry -> result_assoc() as $rows )				{					if( $rows['handling_type']==3 )					{						$html_count++;						$html_legend  = "<a href=\"javascript:void(0);\" class=\"legend_label\" onclick=\"getLevelMiddle('".$rows['handling_type']."','second_level_user');\"> # ".$rows['group_profile']."</a>";						$html_content.= "&nbsp;".$this -> Form -> jpResulCheck('second_level_user', $rows['full_name'],$rows['UserId'],'onChange=ThreeLevelUser(this,"'.$rows['handling_type'].'");')."&nbsp;<br>";					}					else					{						$html_count++;						$html_legend  = "<a href='javascript:void(0);' class='legend_label' onclick=\"getLevelMiddle('".$rows['handling_type']."','three_level_user');\"> # ".$rows['group_profile']."</a>";						$html_content.= "&nbsp;".$this -> Form -> jpResulCheck('three_level_user', $rows['full_name'],$rows['UserId'])."&nbsp;<br>";					}					}								if( $html_count > 0)				{					echo json_encode(array('result'=>1, 'content_html'=> $html_content, 'legend_html' => $html_legend ));				}				else{					echo json_encode(array('result'=>0, 'content_html'=> $html_content, 'legend_html' => $html_legend ));				}			}			else{				echo json_encode(array('result'=>0, 'content_html'=> '', 'legend_html' => '' ));				}			}				}	/** rekursiv User ***/		private function get_user_by_handle()	{		switch($_SESSION['handling_type'] )		{			case 1: 				$sql =" SELECT * FROM tms_agent a where a.profile_id='".USER_LEVEL_MGR."'"; 				break;						case 2 : 				$sql =" SELECT * FROM tms_agent a where a.profile_id='".USER_LEVEL_SPV."' AND a.mgr_id='".$_SESSION['UserId']."'"; 			break; 						case 3 : 				$sql =" SELECT * FROM tms_agent a where a.profile_id='".USER_LEVEL_AGENT."' AND a.spv_id='".$_SESSION['UserId']."'"; 			break;				default:				$sql =" SELECT * FROM tms_agent a where a.profile_id='".USER_LEVEL_MGR."'"; 			break;			}					$qry = $this -> query($sql);		foreach($qry -> result_assoc() as $rows )		{			$datas[$rows['UserId']] = $rows;		}				return $datas;			} /** get campaign **/			function getCampaignList()	{		foreach ( $this -> Entity -> get_list_campaignId() as $k => $rows )		{			echo $this -> Form -> jpCheck('campaign_name', $rows['CampaignName'],$rows['CampaignNumber'])."&nbsp;<br>";		}	}	/** show result **/		function getResultList()	{		foreach ( $this -> Entity -> get_list_reasonid() as $k => $rows )		{			echo $this -> Form -> jpCheck('reason_name', $rows['CallReasonDesc'],$rows['CallReasonId'])."&nbsp;<br>";		}	}		/** get user list **/		function getUersList()	{			switch($_SESSION['handling_type'] )		{			case 1 : 				$label = "<legend> <a href='javascript:void(0);' class='legend_label' onclick='getLevelTop(2);'> # Manager </a></legend>";			break;						case 2 : 				$label = "<legend> <a href='javascript:void(0);' class='legend_label' onclick='getLevelTop(3);'> # Supervisor </a></legend>"; 			break;						case 3 : 				$label = "<legend> <a href='javascript:void(0);' class='legend_label' onclick='getLevelTop(4);'> # Telemarketer </a></legend>"; 			break;		}			if( $_SESSION)				echo "<div style='border:1px solid #dddddd;width:400px;height:150px;overflow:auto;'>				<fieldset style='border:0px solid #dddddd;'>{$label}";										foreach( $this -> get_user_by_handle() as $k => $rows )					{							echo $this -> Form -> jpCheck('first_level_user', $rows['full_name'],$rows['UserId'],'onChange=FirstLevelUser(this,"'.$rows['handling_type'].'");')."&nbsp;<br>";						}				echo "</fieldset></div>";			}	}	new TarikData();	?>